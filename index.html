<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #f9f9f9;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        h2 {
            margin-top: 20px;
            margin-bottom: 10px;
        }
        #scan-btn, #close-btn {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        video {
            width: 100%;
            max-width: 400px;
            margin-top: 10px;
            display: none; /* –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è Android */
            border-radius: 8px;
            border: 2px solid #ccc;
        }
    </style>
</head>
<body>

    <h2>üì∑ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR</h2>

    <button id="scan-btn">üì∑ –ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <video id="video" autoplay playsinline></video>
    <button id="close-btn">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>

    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        let qrText = null;
        const video = document.getElementById('video');
        let stream;

        document.getElementById('scan-btn').addEventListener('click', async () => {
            if (Telegram.WebApp.platform === 'ios') {
                // iOS: –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–∫–∞–Ω–µ—Ä Telegram
                Telegram.WebApp.showScanQrPopup({});
            } else {
                // Android: –∏—Å–ø–æ–ª—å–∑—É–µ–º BarcodeDetector
                if (!('BarcodeDetector' in window)) {
                    alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–æ–≤.');
                    return;
                }
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    video.srcObject = stream;
                    await video.play();
                    video.style.display = 'block';

                    const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });

                    async function detect() {
                        try {
                            const barcodes = await barcodeDetector.detect(video);
                            if (barcodes.length > 0) {
                                qrText = barcodes[0].rawValue;
                                console.log("QR-–∫–æ–¥: ", qrText);

                                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                                Telegram.WebApp.MainButton.setText('‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å QR-–∫–æ–¥');
                                Telegram.WebApp.MainButton.show();

                                // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É –ø–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                                stream.getTracks().forEach(track => track.stop());
                                video.style.display = 'none';
                            } else {
                                requestAnimationFrame(detect);
                            }
                        } catch (err) {
                            console.error("–û—à–∏–±–∫–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏:", err);
                            requestAnimationFrame(detect);
                        }
                    }

                    detect();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
                    Telegram.WebApp.showAlert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ.');
                }
            }
        });

        // –ö–æ–≥–¥–∞ Telegram –ø–æ–ª—É—á–∏—Ç —Ç–µ–∫—Å—Ç QR-–∫–æ–¥–∞ —á–µ—Ä–µ–∑ –Ω–∞—Ç–∏–≤–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
        Telegram.WebApp.onEvent('qrTextReceived', (text) => {
            qrText = text;
            console.log("QR-–∫–æ–¥ —á–µ—Ä–µ–∑ showScanQrPopup:", qrText);

            // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            Telegram.WebApp.MainButton.setText('‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å QR-–∫–æ–¥');
            Telegram.WebApp.MainButton.show();
        });

        // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é –∫–Ω–æ–ø–∫—É Telegram
        Telegram.WebApp.MainButton.onClick(() => {
            if (qrText) {
                try {
                    Telegram.WebApp.sendData(qrText);
                    console.log("‚úÖ sendData –≤—ã–∑–≤–∞–Ω:", qrText);
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ sendData:", error);
                }
            }
        });

        // –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—Ä—ã—Ç—å"
        document.getElementById('close-btn').addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            Telegram.WebApp.close();
        });
    </script>

</body>
</html>


